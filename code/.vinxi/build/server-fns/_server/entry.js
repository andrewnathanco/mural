import{fromJSON as I,crossSerializeStream as $}from"seroval";import{CustomEventPlugin as g,DOMExceptionPlugin as S,EventPlugin as P,FormDataPlugin as R,HeadersPlugin as w,ReadableStreamPlugin as y,RequestPlugin as E,ResponsePlugin as v,URLSearchParamsPlugin as x,URLPlugin as b}from"seroval-plugins/web";import{provideRequestEvent as L}from"solid-js/web/storage";import{toWebRequest as F,getRequestIP as U,eventHandler as H,getHeader as u,getRequestURL as C,readFormData as D,readBody as N,setHeader as k}from"h3";const p="Invariant Violation",{setPrototypeOf:z=function(e,t){return e.__proto__=t,e}}=Object;class f extends Error{framesToPop=1;name=p;constructor(t=p){super(typeof t=="number"?`${p}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),z(this,f.prototype)}}function h(e,t){if(!e)throw new f(t)}const T=Symbol("h3Event"),l=Symbol("fetchEvent"),J={get(e,t){return t===l?e:e[t]??e[T][t]}};function M(e){return new Proxy({request:F(e),clientAddress:U(e),locals:{},[T]:e},J)}function W(e){if(!e[l]){const t=M(e);e[l]=t}return e[l]}function d(e,t){return new ReadableStream({start(s){$(t,{scopeId:e,plugins:[g,S,P,R,w,y,E,v,x,b],onSerialize(n,a){const i=a?`($R["${e}"]=[],${n})`:n;s.enqueue(new TextEncoder().encode(`${i};
`))},onDone(){s.close()},onError(n){s.error(n)}})}})}async function _(e){h(e.method==="POST",`Invalid method ${e.method}. Expected POST.`);const t=u(e,"x-server-id"),s=u(e,"x-server-instance"),n=C(e);let a,i;if(t)h(typeof t=="string","Invalid server function"),[a,i]=t.split("#");else if(a=n.searchParams.get("id"),i=n.searchParams.get("name"),!a||!i)throw new Error("Invalid request");const q=(await globalThis.MANIFEST["server-fns"].chunks[a].import())[i];let o=[];if(!s){const r=n.searchParams.get("args");r&&JSON.parse(r).forEach(c=>o.push(c))}const m=u(e,"content-type");m.startsWith("multipart/form-data")||m.startsWith("application/x-www-form-urlencoded")?o.push(await D(e)):o=I(await N(e),{plugins:[g,S,P,R,w,y,E,v,x,b]});try{const r=await L(W(e),()=>q(...o));if(!s){const c=r instanceof Error,O=new URL(u(e,"referer"));return new Response(null,{status:302,headers:{Location:O.toString(),...r?{"Set-Cookie":`flash=${JSON.stringify({url:n.pathname+encodeURIComponent(n.search),result:c?r.message:r,error:c,input:[...o.slice(0,-1),[...o[o.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return k(e,"content-type","text/javascript"),d(s,r)}catch(r){return r instanceof Response&&r.status===302?new Response(null,{status:s?204:302,headers:{Location:r.headers.get("Location")}}):new Response(d(s,r),{status:500,headers:{"Content-Type":"text/javascript"}})}}const G=H(_);export{G as default};
